# RouterOS v7 Configuration Script
# Generated by Project Titan
# Date: {{ generation_date }}
# Role: {{ role }}

# --- SCRIPT INJECTION WRAPPER ---
:delay 15s;
:log info "Project Titan: Starting Configuration Apply...";

# --- INITIALIZATION ---
/system identity set name="{{ hostname | default('Titan-Router') }}";

# Create Admin User
/user add name="{{ admin_user }}" password="{{ admin_pass }}" group=full comment="Titan Admin";
# Remove default admin if it exists and isn't the new one
:if ([/user find name="admin"] != "") do={
    :if ("{{ admin_user }}" != "admin") do={
        /user remove admin;
    }
}

# --- CONNECTIVITY ---
# Interfaces
:if ([/interface find name="ether1"] != "") do={
    /interface set ether1 name="WAN";
}
# Create LAN Bridge
/interface bridge add name="LAN-Bridge" vlan-filtering=yes;

# Interface Lists
/interface list add name=WAN
/interface list add name=LAN
/interface list member add interface=WAN list=WAN
/interface list member add interface=LAN-Bridge list=LAN

# Add ports to bridge (assuming ether2-ether5 exist for standard layout)
:foreach iface in=[/interface find default-name~"ether[2-5]"] do={
    /interface bridge port add bridge=LAN-Bridge interface=$iface;
}

# WAN Configuration
{% if wan_type == 'dhcp' %}
/ip dhcp-client add interface=WAN disabled=no;
{% elif wan_type == 'static' %}
/ip address add address={{ wan_ip }}/{{ wan_subnet }} interface=WAN;
/ip route add gateway={{ wan_gateway }};
{% elif wan_type == 'pppoe' %}
/interface pppoe-client add name="pppoe-out1" user="{{ pppoe_user }}" password="{{ pppoe_pass }}" interface=WAN disabled=no;
/interface list member add interface=pppoe-out1 list=WAN;
{% endif %}

# LAN Configuration
/ip address add address={{ lan_ip }}/24 interface=LAN-Bridge;
/ip pool add name=dhcp_pool0 ranges={{ lan_ip | ip_network_start }}-{{ lan_ip | ip_network_end }};
/ip dhcp-server add name=dhcp1 interface=LAN-Bridge address-pool=dhcp_pool0 disabled=no;
/ip dhcp-server network add address={{ lan_ip | ip_network_base }}/24 gateway={{ lan_ip }} dns-server={{ lan_ip }};

# --- WIFI ---
{% if wifi_ssid %}
# WiFi Configuration (Generic CAPsMAN or Local)
# Note: RouterOS v7 WiFi config varies greatly by hardware (wifiwave2 vs wireless). 
# We assume basic wireless package for compatibility or wifiwave2 if present.
:local wifiModule [/system package find name="wifiwave2"];
:if ($wifiModule != "") do={
   # WifiWave2 / AX Logic would go here
   :log info "WifiWave2 detected. Config skipped in base template (TODO).";
} else={
   # Legacy Wireless
   /interface wireless security-profiles add name=titan-profile mode=dynamic-keys authentication-types=wpa2-psk unicast-ciphers=aes-ccm group-ciphers=aes-ccm wpa2-pre-shared-key="{{ wifi_pass }}";
   /interface wireless set [ find default-name=wlan1 ] ssid="{{ wifi_ssid }}" security-profile=titan-profile disabled=no mode=ap-bridge;
   /interface wireless set [ find default-name=wlan2 ] ssid="{{ wifi_ssid }}" security-profile=titan-profile disabled=no mode=ap-bridge;
   /interface bridge port add bridge=LAN-Bridge interface=wlan1;
   /interface bridge port add bridge=LAN-Bridge interface=wlan2;
}
{% endif %}

# --- SECURITY (ZERO TRUST) ---
# Firewall Filter
/ip firewall filter
add chain=input action=accept connection-state=established,related comment="Accept Established/Related"
add chain=input action=accept in-interface-list=LAN comment="Allow Management from LAN"
add chain=input action=accept protocol=icmp comment="Allow Ping"
{% if vpn_enabled %}
add chain=input action=accept dst-port=51820 protocol=udp comment="Allow WireGuard";
{% endif %}
add chain=input action=drop comment="Drop All Other Input";

add chain=forward action=accept connection-state=established,related comment="Accept Established/Related"
add chain=forward action=accept connection-state=new in-interface-list=LAN out-interface-list=WAN comment="Allow LAN to WAN"
add chain=forward action=drop connection-state=invalid comment="Drop Invalid"
add chain=forward action=drop comment="Drop All Other Forward";

# NAT
/ip firewall nat add chain=srcnat out-interface-list=WAN action=masquerade comment="WAN Masquerade";

# Hardening
/ip settings set rp-filter=strict;
/ip service set telnet disabled=yes;
/ip service set ftp disabled=yes;
/ip service set www disabled=yes;
/ip service set ssh port=22 disabled=no;
/ip service set winbox address=192.168.0.0/16,172.16.0.0/12,10.0.0.0/8;

{% if dns_redirect %}
# Force DNS Redirection
/ip firewall nat add chain=dstnat protocol=udp dst-port=53 in-interface-list=LAN action=redirect to-ports=53 comment="Force DNS to Router";
/ip firewall nat add chain=dstnat protocol=tcp dst-port=53 in-interface-list=LAN action=redirect to-ports=53 comment="Force DNS to Router";
/ip dns set allow-remote-requests=yes;
{% endif %}

# --- V7 SPECIFIC FEATURES ---
# WireGuard
{% if vpn_enabled %}
/interface wireguard add name=wg0 listen-port=51820;
/interface wireguard peers add interface=wg0 public-key="{{ wg_peer_public_key }}" allowed-address={{ wg_peer_allowed_ips }};
/ip address add address={{ wg_interface_ip }} interface=wg0;
/interface list member add interface=wg0 list=LAN; 
{% endif %}

# --- ROUTING ---
{% if ospf_enabled %}
# OSPFv3 (Area 0.0.0.0)
/routing ospf instance add name=ospf-instance-1 version=3 router-id={{ lan_ip }};
/routing ospf area add instance=ospf-instance-1 name=backbone area-id=0.0.0.0;
/routing ospf interface-template add area=backbone interfaces=LAN-Bridge;
{% endif %}

{% if bgp_enabled %}
# BGP Peering
/routing bgp connection add name=bgp-peer-1 remote.address=192.0.2.1 .as={{ bgp_asn }} local.role=ebgp;
{% endif %}

# --- QOS ---
{% if qos_type == 'cake' %}
# CAKE Traffic Shaping
/queue type add name=cake-default kind=cake;
/queue simple add name=Global-Queue target={{ lan_ip | ip_network_base }}/24 queue=cake-default/cake-default;
{% elif qos_type == 'simple' %}
# Simple Queues
/queue simple add name=Global-Queue target={{ lan_ip | ip_network_base }}/24 max-limit=100M/100M;
{% else %}
# Default FQ_Codel
/queue type set default kind=fq-codel;
/queue type set default-small kind=fq-codel;
{% endif %}

# --- ADVANCED SERVICES ---
{% if adblock_enabled %}
# Native Ad-Blocking (AdList) - RouterOS v7.15+
/ip dns adlist add url="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts";
/ip dns set allow-remote-requests=yes;
{% endif %}

{% if container_enabled %}
# Container Support
# Note: Requires 'container' package and '/system/device-mode/update container=yes' (or 'advanced' in v7.17+)
/interface veth add name=veth1 address=172.17.0.2/24 gateway=172.17.0.1;
/interface bridge add name=dockers;
/interface bridge port add bridge=dockers interface=veth1;
/ip address add address=172.17.0.1/24 interface=dockers;
/ip firewall nat add chain=srcnat src-address=172.17.0.0/24 out-interface-list=WAN action=masquerade;
{% endif %}

:log info "Project Titan: Configuration Completed.";
